<div class="container-fluid py-4">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="mb-0">User Management</h2>
        <div class="d-flex align-items-center gap-2">
            <button class="btn btn-outline-primary" (click)="toggleFilters()">
                <i class="bi bi-funnel me-1"></i> {{ showFilters ? 'Hide Filters' : 'Show Filters' }}
            </button>
        </div>
    </div>

    <!-- Filter Section -->
    <div class="card mb-4" *ngIf="showFilters">
        <div class="card-body" [formGroup]="filterForm">
            <div class="row g-3">
                <div class="col-md-12">
                    <div class="input-group mb-3">
                        <span class="input-group-text">
                            <i class="bi bi-search"></i>
                        </span>
                        <input 
                            type="text" 
                            class="form-control" 
                            formControlName="search"
                            (keyup.enter)="fetchUsers(true)" 
                            placeholder="Search by name, email...">
                    </div>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Status</label>
                    <select class="form-select" formControlName="status">
                        <option value="">All Statuses</option>
                        <option *ngFor="let status of statusOptions" [value]="status">{{ status }}</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Subscription</label>
                    <select class="form-select" formControlName="subscription">
                        <option value="">All Subscriptions</option>
                        <option *ngFor="let sub of subscriptionOptions" [value]="sub">{{ sub }}</option>
                    </select>
                </div>
                <div class="col-md-6">
                    <label class="form-label">Date Range</label>
                    <div class="row g-2">
                        <div class="col">
                            <input type="date" class="form-control" formControlName="startDate" placeholder="Start date">
                        </div>
                        <div class="col">
                            <input type="date" class="form-control" formControlName="endDate" placeholder="End date">
                        </div>
                    </div>
                </div>
                <div class="col-md-12 d-flex justify-content-end gap-2">
                    <button class="btn btn-outline-secondary" (click)="resetFilters()">
                        <i class="bi bi-arrow-counterclockwise me-1"></i> Reset Filters
                    </button>
                    <button class="btn btn-primary" (click)="fetchUsers(true)">
                        <i class="bi bi-funnel me-1"></i> Apply Filters
                    </button>
                </div>
            </div>
        </div>
    </div>


    <!-- Users Table -->
    <div class="card border-0 shadow-sm">
        <div class="card-body p-0">
            <div class="table-container">
                <table class="table table-hover align-middle mb-0">
                    <thead class="table-light">
                        <tr>
                            <th>User</th>
                            <th>Status</th>
                            <th>Subscription</th>
                            <th>Role</th>
                            <th>Joined Date</th>
                            <th class="text-end">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <ng-container *ngIf="!isLoading; else loadingState">
                            <tr *ngFor="let user of filteredUsers" class="align-middle">
                                <td>
                                    <div class="d-flex align-items-center">
                                        <div class="avatar-sm me-3">
                                            <div class="avatar-title bg-light text-primary rounded">
                                                {{ user.email.charAt(0).toUpperCase() }}
                                            </div>
                                        </div>
                                        <div>
                                            <h6 class="mb-0">{{ user.email }}</h6>
                                            <small class="text-muted">ID: {{ user._id | slice:0:8 }}...</small>
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    <span class="badge"
                                        [ngClass]="user.status === 'ACTIVE' ? 'bg-success' : 'bg-danger'">
                                        {{ user.status }}
                                    </span>
                                </td>
                                <td>
                                    <span class="badge"
                                        [ngClass]="user.subscription === 'PAID' ? 'bg-primary' : 'bg-secondary'">
                                        {{ user.subscription || 'N/A' }}
                                    </span>
                                </td>
                                <td>
                                    <span class="badge bg-info">
                                        {{ user.role || 'N/A' }}
                                    </span>
                                </td>
                                <td>{{ user.createdAt | date: 'mediumDate' }}</td>
                                <td class="text-end">
                                    <button class="btn btn-sm btn-light me-2" (click)="viewUserDetails(user)"
                                        title="View Details">
                                        <i class="bi bi-eye"></i>
                                    </button>
                                    <button class="btn btn-sm btn-light" title="Edit User"
                                        (click)="openEditModal(user)">
                                        <i class="bi bi-pencil"></i>
                                    </button>
                                </td>
                            </tr>
                            <tr *ngIf="filteredUsers.length === 0">
                                <td colspan="6" class="text-center py-4">
                                    <div class="text-muted">No users found</div>
                                </td>
                            </tr>
                        </ng-container>

                        <ng-template #loadingState>
                            <tr>
                                <td colspan="6" class="text-center py-4">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                    <p class="mt-2 mb-0">Loading users...</p>
                                </td>
                            </tr>
                        </ng-template>
                    </tbody>
                </table>
            </div>

            <!-- Pagination -->
            <div class="d-flex justify-content-between align-items-center p-3 border-top">
                <div class="text-muted">
                    Showing {{ (currentPage - 1) * itemsPerPage + 1 }} to 
                    {{ (currentPage * itemsPerPage) > statistics.totalUsers ? statistics.totalUsers : (currentPage * itemsPerPage) }} of {{ statistics.totalUsers }} entries
                </div>
                
                <nav *ngIf="getTotalPages() > 1">
                    <ul class="pagination mb-0">
                        <li class="page-item" [class.disabled]="currentPage === 1">
                            <a class="page-link" href="javascript:;" (click)="onPageChange(1)" aria-label="First">
                                <span aria-hidden="true">&laquo;&laquo;</span>
                            </a>
                        </li>
                        <li class="page-item" [class.disabled]="currentPage === 1">
                            <a class="page-link" href="javascript:;" (click)="onPageChange(currentPage - 1)" aria-label="Previous">
                                <span aria-hidden="true">&laquo;</span>
                            </a>
                        </li>
                        
                        <li *ngFor="let page of getPageNumbers()" class="page-item" [class.active]="page === currentPage">
                            <a class="page-link" href="javascript:;" (click)="onPageChange(page)">{{ page }}</a>
                        </li>
                        
                        <li class="page-item" [class.disabled]="currentPage === getTotalPages()">
                            <a class="page-link" href="javascript:;" (click)="onPageChange(currentPage + 1)" aria-label="Next">
                                <span aria-hidden="true">&raquo;</span>
                            </a>
                        </li>
                        <li class="page-item" [class.disabled]="currentPage === getTotalPages()">
                            <a class="page-link" href="javascript:;" (click)="onPageChange(getTotalPages())" aria-label="Last">
                                <span aria-hidden="true">&raquo;&raquo;</span>
                            </a>
                        </li>
                    </ul>
                </nav>
                
                <div class="d-flex align-items-center">
                    <span class="me-2">Items per page:</span>
                    <select class="form-select form-select-sm" style="width: auto;" [(ngModel)]="itemsPerPage" (change)="onItemsPerPageChange()">
                        <option *ngFor="let size of [5, 10, 20, 50]" [value]="size">{{ size }}</option>
                    </select>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- User Details Modal -->
<div class="modal fade" [class.show]="showUserModal" [style.display]="showUserModal ? 'block' : 'none'" tabindex="-1"
    role="dialog">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">User Details</h5>
                <button type="button" class="btn-close" (click)="closeUserModal()" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <ng-container *ngIf="isLoadingUserDetails; else userDetailsContent">
                    <div class="text-center py-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Loading user details...</p>
                    </div>
                </ng-container>

                <ng-template #userDetailsContent>
                    <div *ngIf="userDetailsError" class="alert alert-danger">
                        {{ userDetailsError }}
                    </div>

                    <div *ngIf="selectedUser" class="user-details">
                        <div class="text-center mb-4">
                            <div class="avatar-lg mx-auto mb-3">
                                <div class="avatar-title bg-light text-primary rounded-circle"
                                    style="width: 80px; height: 80px; line-height: 80px; font-size: 2rem;">
                                    {{ selectedUser.email.charAt(0).toUpperCase() }}
                                </div>
                            </div>
                            <h5 class="mb-1">{{ selectedUser.email }}</h5>
                            <p class="text-muted mb-0">Member since {{ formatDate(selectedUser.createdAt) }}</p>
                        </div>

                        <div class="row g-3">
                            <div class="col-md-6">
                                <h6 class="text-muted mb-2">Status</h6>
                                <span class="badge"
                                    [ngClass]="selectedUser.status === 'ACTIVE' ? 'bg-success' : 'bg-danger'">
                                    {{ selectedUser.status }}
                                </span>
                            </div>
                            <div class="col-md-6">
                                <h6 class="text-muted mb-2">Role</h6>
                                <span class="badge bg-primary">{{ selectedUser.role }}</span>
                            </div>
                            <div class="col-md-6">
                                <h6 class="text-muted mb-2">Subscription</h6>
                                <span class="badge"
                                    [ngClass]="selectedUser.subscription === 'PAID' ? 'bg-primary' : 'bg-secondary'">
                                    {{ selectedUser.subscription || 'N/A' }}
                                </span>
                            </div>
                            <div class="col-md-6">
                                <h6 class="text-muted mb-2">MFA Status</h6>
                                <span class="badge"
                                    [ngClass]="selectedUser.mfa?.enabled ? 'bg-success' : 'bg-secondary'">
                                    {{ selectedUser.mfa?.enabled ? 'Enabled' : 'Disabled' }}
                                </span>
                            </div>
                            <div class="mb-3">
                                <label for="badges" class="form-label">Assigned Badges</label>
                                <select 
                                    class="form-select" 
                                    id="badges" 
                                    [(ngModel)]="removeBadgeId"
                                    [ngModelOptions]="{standalone: true}">
                                    <option [ngValue]="null">--  badge list --</option>
                                    <option *ngFor="let badge of assignedBadges" [ngValue]="badge._id">
                                        {{ badge.title }}
                                    </option>
                                </select>
                            </div>
                            <div class="col-12" *ngIf="selectedUser.refered_by?.length">
                                <h6 class="text-muted mb-2">Referred By</h6>
                                <div>
                                    <span *ngFor="let ref of selectedUser.refered_by"
                                        class="badge bg-light text-dark me-1 mb-1">
                                        {{ ref | slice:0:8 }}...
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                </ng-template>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" (click)="closeUserModal()">Close</button>
            </div>
        </div>
    </div>
</div>




<!-- Edit User Modal -->
<div class="modal fade" [class.show]="showEditModal" [style.display]="showEditModal ? 'block' : 'none'" tabindex="-1"
    aria-labelledby="editUserModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editUserModalLabel">Edit User</h5>
                <button type="button" class="btn-close" (click)="closeEditModal()" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form [formGroup]="editUserForm" (ngSubmit)="updateUser()">
                    <div class="mb-3">
                        <label for="status" class="form-label">Status</label>
                        <select class="form-select" id="status" formControlName="status" required>
                            <option value="ACTIVE">Active</option>
                            <option value="INACTIVE">Inactive</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="subscription" class="form-label">Subscription</label>
                        <select class="form-select" id="subscription" formControlName="subscription" required>
                            <option value="PAID">Paid</option>
                            <option value="FREE">Free</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="badges" class="form-label">Unassigned Badges</label>
                        <select 
                            class="form-select" 
                            id="badges" 
                            [(ngModel)]="selectedBadgeId"
                            [ngModelOptions]="{standalone: true}">
                            <option [ngValue]="null">-- Select a badge --</option>
                            <option *ngFor="let badge of availableBadges" [ngValue]="badge._id">
                                {{ badge.title }}
                            </option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label for="badges" class="form-label">Assigned Badges</label>
                        <select 
                            class="form-select" 
                            id="badges" 
                            [(ngModel)]="removeBadgeId"
                            [ngModelOptions]="{standalone: true}">
                            <option [ngValue]="null">-- Select a badge --</option>
                            <option *ngFor="let badge of assignedBadges" [ngValue]="badge._id">
                                {{ badge.title }}
                            </option>
                        </select>
                    </div>
                   
                    <button type="submit" class="btn btn-primary">Update</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Backdrop for the modal -->
<div class="modal-backdrop fade" [class.show]="showUserModal" [style.display]="showUserModal ? 'block' : 'none'"
    (click)="closeUserModal()">
</div>