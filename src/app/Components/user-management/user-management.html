<div class="container-fluid py-4">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="mb-0">User Management</h2>
        <div class="d-flex align-items-center">
            <div class="input-group" style="width: 300px;">
                <span class="input-group-text bg-white border-end-0">
                    <i class="bi bi-search"></i>
                </span>
                <input type="text" class="form-control border-start-0" [(ngModel)]="searchQuery"
                    placeholder="Search users...">
            </div>
        </div>
    </div>


    <!-- Users Table -->
    <div class="card border-0 shadow-sm">
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead class="table-light">
                        <tr>
                            <th>User</th>
                            <th>Status</th>
                            <th>Subscription</th>
                            <th>Role</th>
                            <th>Joined Date</th>
                            <th class="text-end">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <ng-container *ngIf="!isLoading; else loadingState">
                            <tr *ngFor="let user of filteredUsers" class="align-middle">
                                <td>
                                    <div class="d-flex align-items-center">
                                        <div class="avatar-sm me-3">
                                            <div class="avatar-title bg-light text-primary rounded">
                                                {{ user.email.charAt(0).toUpperCase() }}
                                            </div>
                                        </div>
                                        <div>
                                            <h6 class="mb-0">{{ user.email }}</h6>
                                            <small class="text-muted">ID: {{ user._id | slice:0:8 }}...</small>
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    <span class="badge"
                                        [ngClass]="user.status === 'ACTIVE' ? 'bg-success' : 'bg-danger'">
                                        {{ user.status }}
                                    </span>
                                </td>
                                <td>
                                    <span class="badge"
                                        [ngClass]="user.subscription === 'PAID' ? 'bg-primary' : 'bg-secondary'">
                                        {{ user.subscription || 'N/A' }}
                                    </span>
                                </td>
                                <td>
                                    <span class="badge bg-info">
                                        {{ user.role || 'N/A' }}
                                    </span>
                                </td>
                                <td>{{ formatDate(user.createdAt) }}</td>
                                <td class="text-end">
                                    <button class="btn btn-sm btn-light me-2" (click)="viewUserDetails(user._id)"
                                        title="View Details">
                                        <i class="bi bi-eye"></i>
                                    </button>
                                    <button class="btn btn-sm btn-light" title="Edit User"
                                        (click)="openEditModal(user)">
                                        <i class="bi bi-pencil"></i>
                                    </button>
                                </td>
                            </tr>
                            <tr *ngIf="filteredUsers.length === 0">
                                <td colspan="6" class="text-center py-4">
                                    <div class="text-muted">No users found</div>
                                </td>
                            </tr>
                        </ng-container>

                        <ng-template #loadingState>
                            <tr>
                                <td colspan="6" class="text-center py-4">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                    <p class="mt-2 mb-0">Loading users...</p>
                                </td>
                            </tr>
                        </ng-template>
                    </tbody>
                </table>
            </div>

            <!-- Pagination -->
            <div class="d-flex justify-content-between align-items-center px-4 py-3 border-top">
                <div class="text-muted small">
                    Showing <span class="fw-semibold">{{ (currentPage - 1) * itemsPerPage + 1 }}-{{ currentPage *
                        itemsPerPage }}</span> of
                    <span class="fw-semibold">{{ statistics.totalUsers }}</span> users
                </div>
                <nav>
                    <ul class="pagination pagination-sm mb-0">
                        <li class="page-item" [class.disabled]="currentPage === 1">
                            <a class="page-link" href="javascript:void(0)"
                                (click)="onPageChange(currentPage - 1)">Previous</a>
                        </li>
                        <li class="page-item" *ngFor="let page of getPageNumbers()"
                            [class.active]="page === currentPage">
                            <a class="page-link" href="javascript:void(0)" (click)="onPageChange(page)">{{ page }}</a>
                        </li>
                        <li class="page-item" [class.disabled]="currentPage === getTotalPages()">
                            <a class="page-link" href="javascript:void(0)"
                                (click)="onPageChange(currentPage + 1)">Next</a>
                        </li>
                    </ul>
                </nav>
            </div>
        </div>
    </div>
</div>

<!-- User Details Modal -->
<div class="modal fade" [class.show]="showUserModal" [style.display]="showUserModal ? 'block' : 'none'" tabindex="-1"
    role="dialog">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">User Details</h5>
                <button type="button" class="btn-close" (click)="closeUserModal()" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <ng-container *ngIf="isLoadingUserDetails; else userDetailsContent">
                    <div class="text-center py-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Loading user details...</p>
                    </div>
                </ng-container>

                <ng-template #userDetailsContent>
                    <div *ngIf="userDetailsError" class="alert alert-danger">
                        {{ userDetailsError }}
                    </div>

                    <div *ngIf="selectedUser" class="user-details">
                        <div class="text-center mb-4">
                            <div class="avatar-lg mx-auto mb-3">
                                <div class="avatar-title bg-light text-primary rounded-circle"
                                    style="width: 80px; height: 80px; line-height: 80px; font-size: 2rem;">
                                    {{ selectedUser.email.charAt(0).toUpperCase() }}
                                </div>
                            </div>
                            <h5 class="mb-1">{{ selectedUser.email }}</h5>
                            <p class="text-muted mb-0">Member since {{ formatDate(selectedUser.createdAt) }}</p>
                        </div>

                        <div class="row g-3">
                            <div class="col-md-6">
                                <h6 class="text-muted mb-2">Status</h6>
                                <span class="badge"
                                    [ngClass]="selectedUser.status === 'ACTIVE' ? 'bg-success' : 'bg-danger'">
                                    {{ selectedUser.status }}
                                </span>
                            </div>
                            <div class="col-md-6">
                                <h6 class="text-muted mb-2">Role</h6>
                                <span class="badge bg-primary">{{ selectedUser.role }}</span>
                            </div>
                            <div class="col-md-6">
                                <h6 class="text-muted mb-2">Subscription</h6>
                                <span class="badge"
                                    [ngClass]="selectedUser.subscription === 'PAID' ? 'bg-primary' : 'bg-secondary'">
                                    {{ selectedUser.subscription || 'N/A' }}
                                </span>
                            </div>
                            <div class="col-md-6">
                                <h6 class="text-muted mb-2">MFA Status</h6>
                                <span class="badge"
                                    [ngClass]="selectedUser.mfa?.enabled ? 'bg-success' : 'bg-secondary'">
                                    {{ selectedUser.mfa?.enabled ? 'Enabled' : 'Disabled' }}
                                </span>
                            </div>
                            <div class="col-12" *ngIf="selectedUser.badges?.length">
                                <h6 class="text-muted mb-2">Badges</h6>
                                <div>
                                    <span *ngFor="let badge of selectedUser.badges" class="badge bg-info me-1 mb-1">
                                        {{ badge }}
                                    </span>
                                </div>
                            </div>
                            <div class="col-12" *ngIf="selectedUser.refered_by?.length">
                                <h6 class="text-muted mb-2">Referred By</h6>
                                <div>
                                    <span *ngFor="let ref of selectedUser.refered_by"
                                        class="badge bg-light text-dark me-1 mb-1">
                                        {{ ref | slice:0:8 }}...
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                </ng-template>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" (click)="closeUserModal()">Close</button>
            </div>
        </div>
    </div>
</div>


<!-- Edit User Modal -->
<div class="modal fade" [class.show]="showEditModal" [style.display]="showEditModal ? 'block' : 'none'" tabindex="-1"
    aria-labelledby="editUserModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editUserModalLabel">Edit User</h5>
                <button type="button" class="btn-close" (click)="closeEditModal()" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form [formGroup]="editUserForm" (ngSubmit)="updateUser()">
                    <div class="mb-3">
                        <label for="status" class="form-label">Status</label>
                        <select class="form-select" id="status" formControlName="status" required>
                            <option value="ACTIVE">Active</option>
                            <option value="INACTIVE">Inactive</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="subscription" class="form-label">Subscription</label>
                        <select class="form-select" id="subscription" formControlName="subscription" required>
                            <option value="PAID">Paid</option>
                            <option value="FREE">Free</option>
                        </select>
                    </div>
                    <button type="submit" class="btn btn-primary">Update</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Backdrop for the modal -->
<div class="modal-backdrop fade" [class.show]="showUserModal" [style.display]="showUserModal ? 'block' : 'none'"
    (click)="closeUserModal()">
</div>